<?php

declare(strict_types=1);

namespace ExpressiveTest\Authorization\Rbac;

use PHPUnit\Framework\TestCase;
use Prophecy\Prophecy\ObjectProphecy;
use Psr\Container\ContainerInterface;
use Expressive\Authorization\Exception;
use Expressive\Authorization\Rbac\LaminasRbac;
use Expressive\Authorization\Rbac\LaminasRbacAssertionInterface;
use Expressive\Authorization\Rbac\LaminasRbacFactory;

class LaminasRbacFactoryTest extends TestCase
{
    /** @var ContainerInterface|ObjectProphecy */
    private $container;

    protected function setUp()
    {
        $this->container = $this->prophesize(ContainerInterface::class);
    }

    public function testFactoryWithoutConfig()
    {
        $this->container->get('config')->willReturn([]);

        $factory = new LaminasRbacFactory();

        $this->expectException(Exception\InvalidConfigException::class);
        $this->expectExceptionMessage('expressive-authorization-rbac');
        $factory($this->container->reveal());
    }

    public function testFactoryWithoutLaminasRbacConfig()
    {
        $this->container->get('config')->willReturn(['expressive-authorization-rbac' => []]);

        $factory = new LaminasRbacFactory();

        $this->expectException(Exception\InvalidConfigException::class);
        $this->expectExceptionMessage('expressive-authorization-rbac.roles');
        $factory($this->container->reveal());
    }

    public function testFactoryWithoutPermissions()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => []
            ]
        ]);

        $factory = new LaminasRbacFactory();

        $this->expectException(Exception\InvalidConfigException::class);
        $this->expectExceptionMessage('expressive-authorization-rbac.permissions');
        $factory($this->container->reveal());
    }

    public function testFactoryWithEmptyRolesPermissionsWithoutAssertion()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [],
                'permissions' => []
            ]
        ]);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(false);
        $this->container->has(\Zend\Expressive\Authorization\Rbac\ZendRbacAssertionInterface::class)->willReturn(false);

        $factory = new LaminasRbacFactory();
        $laminasRbac = $factory($this->container->reveal());
        $this->assertInstanceOf(LaminasRbac::class, $laminasRbac);
    }

    public function testFactoryWithEmptyRolesPermissionsWithAssertion()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [],
                'permissions' => []
            ]
        ]);

        $assertion = $this->prophesize(LaminasRbacAssertionInterface::class);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(true);
        $this->container->get(LaminasRbacAssertionInterface::class)->willReturn($assertion->reveal());

        $factory = new LaminasRbacFactory();
        $laminasRbac = $factory($this->container->reveal());
        $this->assertInstanceOf(LaminasRbac::class, $laminasRbac);
    }

    public function testFactoryWithoutAssertion()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [
                    'administrator' => [],
                    'editor'        => ['administrator'],
                    'contributor'   => ['editor'],
                ],
                'permissions' => [
                    'contributor' => [
                        'admin.dashboard',
                        'admin.posts',
                    ],
                    'editor' => [
                        'admin.publish',
                    ],
                    'administrator' => [
                        'admin.settings',
                    ],
                ],
            ],
        ]);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(false);
        $this->container->has(\Zend\Expressive\Authorization\Rbac\ZendRbacAssertionInterface::class)->willReturn(false);

        $factory = new LaminasRbacFactory();
        $laminasRbac = $factory($this->container->reveal());
        $this->assertInstanceOf(LaminasRbac::class, $laminasRbac);
    }

    public function testFactoryWithAssertion()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [
                    'administrator' => [],
                    'editor'        => ['administrator'],
                    'contributor'   => ['editor'],
                ],
                'permissions' => [
                    'contributor' => [
                        'admin.dashboard',
                        'admin.posts',
                    ],
                    'editor' => [
                        'admin.publish',
                    ],
                    'administrator' => [
                        'admin.settings',
                    ],
                ],
            ],
        ]);
        $assertion = $this->prophesize(LaminasRbacAssertionInterface::class);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(true);
        $this->container->get(LaminasRbacAssertionInterface::class)->willReturn($assertion->reveal());

        $factory = new LaminasRbacFactory();
        $laminasRbac = $factory($this->container->reveal());
        $this->assertInstanceOf(LaminasRbac::class, $laminasRbac);
    }

    public function testFactoryWithInvalidRole()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [
                    1 => [],
                ],
                'permissions' => [],
            ],
        ]);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(false);
        $this->container->has(\Zend\Expressive\Authorization\Rbac\ZendRbacAssertionInterface::class)->willReturn(false);

        $factory = new LaminasRbacFactory();

        $this->expectException(Exception\InvalidConfigException::class);
        $factory($this->container->reveal());
    }

    public function testFactoryWithUnknownRole()
    {
        $this->container->get('config')->willReturn([
            'expressive-authorization-rbac' => [
                'roles' => [
                    'administrator' => [],
                ],
                'permissions' => [
                    'contributor' => [
                        'admin.dashboard',
                        'admin.posts',
                    ]
                ]
            ]
        ]);
        $this->container->has(LaminasRbacAssertionInterface::class)->willReturn(false);
        $this->container->has(\Zend\Expressive\Authorization\Rbac\ZendRbacAssertionInterface::class)->willReturn(false);

        $factory = new LaminasRbacFactory();

        $this->expectException(Exception\InvalidConfigException::class);
        $factory($this->container->reveal());
    }
}
